<div>
    <div class="modal fade" id="Modal" tabindex="-1" aria-labelledby="ModalLabel" aria-hidden="true">
        <div class="modal-dialog {% block modalClass %}{% endblock %}">
            <form action={% block actionURL %}{% endblock %} method="POST" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="action" value="add" class="form-action"/>
                <input type="hidden" name="id" />
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabel">Ajouter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% block modalForm %}{% endblock modalForm %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-primary action-text">Ajouter</button>
                </div>
            </form>
        </div>
    </div>
    <div class="d-flex justify-content-between">
        <div class="page-title">
            <h4>{% block pageName %}{% endblock %}</h4>
        </div>
        <div class="page-path">
            <a href={% url 'admin-dashboard' %} class="text-black">Home</a>
            <span class="mx-1">/</span>
            <a href="javascript:void(0)" class="text-black">{% block pathName %}{% endblock %}</a>
        </div>
    </div>
    <div class="mt-5">
        <div class="mb-5 text-end">
            <button class="btn fd-bg-primary text-white shadow-sm text-capitalize" data-bs-toggle="modal"
                data-bs-target="#Modal">Ajouter</button>
        </div>
        <div class="table-responsive">
            <table id="table" class="table table-striped table-responsive shadow-sm fw-light" style="width: 100%">
                <thead class="fd-bg-secondary text-white-50">
                    <tr>
                        {% block tableHead %}{% endblock tableHead %}
                    </tr>
                </thead>
                <tbody>
                    <!-- Les données des cours seront ajoutées ici dynamiquement -->
                </tbody>
            </table>
        </div>
    </div>
    <script>

        $(document).ready(function () {

            const btn = document.querySelector('.btn-duplicate');
            const formContent = document.querySelector('.f-content');
            const formGroup = document.querySelector('.group');

            btn?.addEventListener('click', () => {
                const clone = formGroup.cloneNode(true)
                formContent.appendChild(clone)
            })
            
            // Initialiser DataTables
            $('#table').DataTable({

                data: {% block data %}{% endblock data %},
                language: langueOptions,
                columns: [
                    {% block columns %}{% endblock %}
                    {
                        data: null,
                        render: function (data, type, row) {
                            return `
                                <div class="d-flex gap-2 justify-content-center">
                                    <a href="javascript:void(0)"
                                        class="fd-bg-silver text-center shadow-sm fd-color-secondary rounded-5 btn-action"
                                        data-bs-toggle="modal" data-bs-target="#Modal"
                                        data-bs-whatever='${JSON.stringify(data)}'
                                        title='Modifier ${Object.values(data)[1]}'
                                    >
                                        <i class="mdi mdi-pen"></i>
                                    </a>
                                    <a href="javascript:void(0)"
                                        class="fd-bg-silver delete-btn text-center shadow-sm text-danger rounded-5 btn-action"
                                        data-timetable-id='${data.id}'
                                        title='Supprimer ${Object.values(data)[1]}'
                                        
                                        >
                                        <i class="mdi mdi-trash-can"></i>
                                    </a>
                                </div>
                            `;
                        }
                    }
                ]
            }
            );

            const modal = document.getElementById('Modal')

            modal.addEventListener('show.bs.modal', function (event) {
                // Button that triggered the modal
                const button = event.relatedTarget
                // Extract info from data-bs-* attributes
                const recipient = JSON.parse(button.getAttribute('data-bs-whatever'))
                // If necessary, you could initiate an AJAX request here
                // and then do the updating in a callback.
                //
                // Update the modal's content.
                const modalTitle = modal.querySelector('.modal-title')
                const actionText = modal.querySelector('.action-text')
                const action = modal.querySelector('.form-action')
                const all = modal.querySelectorAll('#Modal input, #Modal textarea, #Modal select')

                if(recipient) {

                    modalTitle.textContent = 'Modifier'
                    actionText.textContent = 'Modifier'
                    action.value = 'edit'

                    for (const input of all) {

                        for (const value in recipient) {

                            if (input.name == value) {

                                input.value = recipient[value]
                            }
                        }
                    }

                }else {
                    
                    modalTitle.textContent = 'Ajouter'
                    actionText.textContent = 'Ajouter'
                    action.value = 'add'

                }
            })

            modal.addEventListener('hidden.bs.modal', function (event) {

                const form = modal.querySelector('form')
                form.reset()
                if (form.getAttribute('data-timetable-reload')) {

                    window.location.reload()
                }
            })

            const form = $('#Modal form');
            const loading = '<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Loading...'


            $('.delete-btn').each(function(i,e) {

                $(e).on('click', () => {

                    App.alert('question', 'Supprimer', 'Êtes-vous sûr de vouloir supprimer ?', () => {

                        const csrfToken = App.getCookie('csrftoken');

                        $.ajax({

                            url: form.attr('action'),
                            type: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken
                            },
                            data: {action: 'del', id: $(e).data('timetable-id')},
                            success: function(response) {

                                if(!response.success) {

                                    return toastr.error(response.message)
        
                                }
        
                                toastr.success(response.message)
                                setTimeout(() => {
                                    window.location.reload()
                                }, 500)

                            },
        
                        })

                    });
                })
            });

            form.on('submit', (e) => {
                
                e.preventDefault()
                
                const actionPrevText = $('.action-text').get(0).textContent
                $('.action-text').html(loading)
                
                const formData = new FormData(form.get(0))

                $.ajax({

                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false, 
                    success: function(response) {

                        $('.action-text').text(actionPrevText)

                        if(!response.success) {

                            return toastr.error(response.message)

                        }

                        form.get(0).setAttribute('data-timetable-reload', true)
                        return toastr.success(response.message)
                    },

                })
            })
        });

    </script>
</div>